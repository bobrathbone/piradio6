#!/usr/bin/env python3
#
# Raspberry Pi Radio - Album artwork extraction from current URL 
#
# $Id: artwork_class.py,v 1.12 2025/11/15 10:07:42 bob Exp $
#
# Authors : Bob Rathbone and Jeff (musicalic)
# Site    : http://www.bobrathbone.com
#
# License: GNU V3, See https://www.gnu.org/copyleft/gpl.html
#
# Disclaimer: Software is provided as is and absolutly no warranties are implied or given.
#       The authors shall not be liable for any loss or damage however caused.
#
import sys
import requests
import time
import subprocess
import urllib.parse
from io import BytesIO

API_DISCOGS_TOKEN = "SkLpyuNUuVTglclfwrvdBuxiucbjCFwMaXKLsAOg"
BASE_URL = "https://api.discogs.com/database/search?q="
HEADERS = {'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/50.0.2661.102 Safari/537.36'}

# Artwork handler class
class Artwork:

    coverImage = None
    
    def __init__(self): 
        return

    # Return cover image in Bytes
    def getCoverImageBytes(self):
        return self.coverImage

    def getCoverImageFromInfo(self,broadcast_info):
        coverImage = None 
        coverURL = self.getCoverURL(broadcast_info)
        if coverURL != None and ':' in coverURL :
            coverImage = self.getCoverImageFromURL(coverURL)
        return coverImage

    # Get the broadcast info from the current radio station or track
    def get_broadcast_info(self):
        broadcast_info = ""
        try:
            result = subprocess.run("mpc current", shell=True, capture_output=True, text=True)
            broadcast_info = result.stdout.strip()
        except Exception as e:
            print(str(e))
        return broadcast_info

    def getCoverImageFromURL(self,cover_url):
        self.coverImage = None
        try:
            # https://coderslegacy.com/python/load-image-from-web-url-pygame/
            response = requests.get(cover_url, headers=HEADERS)
            #response = requests.get('https://www.denofgeek.com/wp-content/uploads/2022/05/Leged-of-Zelda-Link.jpg')
            if response.status_code == 200:
                type = response.headers['content-type']
                self.coverImage = BytesIO(response.content)
            else:
                print("ERROR: getCoverImageFromURL got error code" % response.status_code)
        except Exception as e:
            print(e)
        return self.coverImage


    # Get the cover artwork URL from the broadcast info
    def getCoverURL(self,broadcast_info):
        # To get the art cover URL we are using the Discogs API
        cover_url = ""
        try:
            # try to extract the singer and the name of the song
            try:
                title = broadcast_info[broadcast_info.index(":")+1 :] 
            except:
                title = broadcast_info
            # Build the url following this pattern:
            # https://api.discogs.com/database/search?q=Rose%20Laurens%20-%20Quand%20Tu%20Pars%20(12%60%60%20Version)&token=SkLpyuNUuVTglclfwrvdBuxiucbjCFwMaXKLsAOg
            # https://mojoauth.com/escaping/url-escaping-in-python/
            url = BASE_URL + urllib.parse.quote_plus(title) + "&token=" + API_DISCOGS_TOKEN
            # https://developer.mozilla.org/en-US/docs/Web/API/Response
            response = requests.get(url, headers=HEADERS)
            type = response.headers['content-type']
            if type != 'application/json':
                return ""
            data = response.json() # Python dictionary
            if len(data['results']) > 1:
                # Extract the URL of the art cover image
                cover_url = data['results'][0]['cover_image']
                if not(isinstance(cover_url, str)):
                    cover_url = None
        except Exception as e:
            print(str(e))
        return cover_url 

# End of Artwork class

### Main test routine ###
# Extracts the cover image url from station URL and writes it to a file
if __name__ == "__main__":
    import time
    import shutil

    last_info = None
    artwork = Artwork()
    image_file = "/home/pi/radio_image.jpg"
    no_image = "images/no_image.jpg" 

    try:
        while True:
            broadcast_info = artwork.get_broadcast_info()
            print(broadcast_info)
            img = artwork.getCoverImageFromInfo(broadcast_info)
            if img != None and broadcast_info != last_info:
                f = open(image_file,"wb")
                f.write(img.getbuffer())
                f.close()
                print("Wrote",image_file)
                last_info = broadcast_info 
            elif img == None:
                shutil.copyfile(no_image, image_file)
            time.sleep(2)

    except KeyboardInterrupt:
        print("Stopped")
        sys.exit(0)

# End of script
# set tabstop=4 shiftwidth=4 expandtab
# retab
